---
title: "Collect SNOTEL SWE from Willow Park and compare directly to model output"
author: "Logan Karsten"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    highlight: tango  ##probably the best
---
```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(comment=NA)
opts_chunk$set(prompt=TRUE)
knit_hooks$set(
  prompt = function(before, options, envir) {
    options(prompt = if (options$engine %in% c('sh','bash')) '$ ' else '> ')
})
```

# Background
Pull SNOTEL SWE at Willow Park, which is located inside the Big Thompson test domain. 
This vignette also reads in SWE from the model output using the coordinates from the
SNOTEL metadata. Plots comparing the data are generated for the user. 

# Setup 
Load the rwrfhydro package.
```{r, results='hide', message=FALSE, warning=FALSE}
library("rwrfhydro")
```

Load ggplo2 for plotting puposes
```{r, results='hide'}
library(ggplot2)
```

Establish paths to the model output and geoGrid file for the test case.
```{r, results='hide'}
geoFile <- '~/wrfHydroTestCases/BigThompson/DOMAIN/geo_em.nc'
modelDir <- '~/wrfHydroTestCases/BigThompson/run.TerrainRouting'
```

Establish the SNOTEL site of interest, which is Willow Park in this case.
```{r, results='hide'}
stationMeta <- subset(snotelMeta,site_name == "Willow Park ")
stationMeta
```

# Data Extraction
Obtain the domain I/J coordinates using the SNOTEL lat/lon and the GetGeogridIndex function contained
within rwrfhydro.
```{r, results='hide'}
snoIJ <- GetGeogridIndex(data.frame(lon=stationMeta$lon,lat=stationMeta$lat),geoFile)
snoIJ
```

Pull all SNOTEL observations for the given site for the 2012/2013 years.
```{r, results='hide'}
snoObs <- GetSnotel(stationMeta$site_id,series="Daily",startYr=2012,endYr=2013)
head(snoObs)
```

Pull modeled SWE at the SNOTEL point from the model directory. For a detailed explanation
on the method of model extraction, see the GetMultiNcdf vignette for further explanation.
Data is pulled from the pixel cell corresponding to the SNOTEL site. 
```{r, results='hide'}
lsmFiles <- list.files(path=modelDir,pattern='LDASOUT_DOMAIN',full.names=TRUE)
fList <- list(lsm=lsmFiles)
lsmVars <- list(SWE='SNEQV')
varList <- list(lsm=lsmVars)
lsmInds <- list(SWE=list(start=c(snoIJ$we,snoIJ$sn,1),end=c(snoIJ$we,snoIJ$sn,1),stat='mean'))
indList <- list(lsm=lsmInds)
fileData <- GetMultiNcdf(file=fList,var=varList,ind=indList,parallel=FALSE)
head(fileData)
```

Next, subset observations based on the date range that is contained within the modeled data
frame. We will then append the subsetted obserations into the data frame in preparation
for plotting.  
```{r}
fileData$obsSWE <- NA
for (step in 1:length(fileData$value)){
   modPOSIX <- fileData$POSIXct[step]
   ind <- which(snoObs$Date == as.Date(modPOSIX))
   if (length(ind) != 0){
      fileData$obsSWE[step] <- snoObs$SWE_mm[ind[1]]
   }
}
```

Finally, plot the modeled values agains the observed SWE for this SNOTEL 
point using the ggplo2 package.
```{r, fig.width=8,fig.height=8}
plotTitle <- paste0('Big Thompson Modeled SWE Against Observations for: ',stationMeta$site_name[1])
ggplot(fileData,aes(x=POSIXct,y=value,color='Simulated')) + geom_line() + 
  geom_line(data=fileData, aes(x=POSIXct,y=obsSWE,color='Observed'),size=1.2,linetype='dashed') +
  scale_color_manual(name='Legend',values=c('black','red')) + 
  ggtitle(plotTitle) + 
  xlab('Date') + 
  ylab('SWE (mm)') + 
  theme_bw(base_size=14)
```

