---
title: "Collect SNOTEL SWE from Niwot Ridge and compare directly to model output"
author: "Logan Karsten"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Collect SNOTEL SWE for Niwot Ridge and compare directly to model output}
  %\\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# Background
Pull SNOTEL SWE at a selected site within the WRF-Hydro model domain. 
This vignette also reads in SWE from the model output using the coordinates from the
SNOTEL metadata. Plots comparing the data are generated for the user. 

# Setup 
Load the rwrfhydro package.
```{r, results='hide', warning=F, message=F}
library(rwrfhydro)
```

Load ggplot2 for plotting puposes.
```{r, results='hide', warning=F, message=F}
library(ggplot2)
```

Establish paths to the model output and geogrid file for the test case.
```{r, results='hide'}
geoFile <- '../data/geo_em.nc'
modelDir <- '../data/OUTPUT_SPRING_REACH'
```

Establish the SNOTEL site of interest.
```{r, results='hide'}
stationMeta <- subset(snotelMeta, site_name == "Hourglass Lake ")
```

# Data Extraction
Obtain the domain I/J coordinates using the SNOTEL lat/lon and the GetGeogridIndex function contained
within rwrfhydro.
```{r, results='hide', warning=F, message=F}
snoIJ <- GetGeogridIndex(data.frame(lon=stationMeta$lon, lat=stationMeta$lat), geoFile)
```

Pull all SNOTEL observations for the given site for the 2012/2013 years.
```{r, results='hide'}
snoObs <- GetSnotel(stationMeta$site_id,series="Daily",startYr=2012,endYr=2013)
```

Pull modeled SWE at the SNOTEL point from the model directory. For a detailed explanation
on the method of model extraction, see the GetMultiNcdf vignette for further explanation.
Data is pulled from the pixel cell corresponding to the SNOTEL site. 
```{r, results='hide'}
lsmFiles <- list.files(path=modelDir,pattern='0000.LDASOUT_DOMAIN',full.names=TRUE)
fList <- list(lsm=lsmFiles)
lsmVars <- list(SWE='SNEQV')
varList <- list(lsm=lsmVars)
lsmInds <- list(SWE=list(start=c(snoIJ$we,snoIJ$sn,1),end=c(snoIJ$we,snoIJ$sn,1),stat='mean'))
indList <- list(lsm=lsmInds)
fileData <- GetMultiNcdf(file=fList,var=varList,ind=indList,parallel=FALSE)
```

Next, subset observations based on the date range that is contained within the modeled data
frame. We will then append the subsetted obserations into the data frame in preparation
for plotting.  
```{r}
fileData$obsSWE <- NA
for (step in 1:length(fileData$value)){
   modPOSIX <- fileData$POSIXct[step]
   ind <- which(snoObs$Date == as.Date(modPOSIX))
   if (length(ind) != 0){
      fileData$obsSWE[step] <- snoObs$SWE_mm[ind[1]]
   }
}
```

Finally, plot the modeled values agains the observed SWE for this SNOTEL 
point using the ggplot2 package.
```{r, fig.width=7}
plotTitle <- paste0('Modeled SWE Against Observations for: ',stationMeta$site_name[1])
ggplot(fileData,aes(x=POSIXct,y=value,color='Simulated')) + geom_line() + 
  geom_line(data=fileData, aes(x=POSIXct,y=obsSWE,color='Observed'),size=1.2,linetype='dashed') +
  scale_color_manual(name='Legend',values=c('black','red')) + 
  ggtitle(plotTitle) + xlab('Date') + ylab('SWE (mm)')
```

