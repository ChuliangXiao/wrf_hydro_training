---
title: "Plot and evaluate simulated WRF-Hydro streamflow using USGS observations"
author: "Aubrey Dugger, James McCreight, Alyssa Hendricks, Joe Mills, Arezoo Rafieei Nasab, and Katelyn FitzGerald"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Streamflow Evaluation}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# Background

USGS streamflow observations are a primary source of hydrologic information and often used for
validation and calibration of hydrlogic models. Web services have been developed
at [*NWIS*](http://waterdata.usgs.gov/nwis) and the [*dataRetrieval*](http://cran.r-project.org/web/packages/dataRetrieval/index.html) R package has emerged to make it easy to get USGS data using R.

This vignette demonstates how to download USGS streamflow observations using the dataRetrieval package, import modeled streamflow from WRF-Hydro output files using functionality from rwrfhydro, and plot both the observed and modeled time series.

# Load packages and scripts
Load required packages and scripts. 
```{r, message=F, warning=F}
library(dataRetrieval)
library(rwrfhydro)
library(data.table)
library(ggplot2)

```

# Specify parameters and paths
Specify required information and paths.  
```{r}
gageID <- "06716100"

modelOutputPath <- "../data/OUTPUT_SPRING_REACH"
routeLinkFile <- "../data/Route_Link.nc"
referenceFile <- "../data/gages.csv"
```

# Import WRF-Hydro simulated streamflow
Import simulated streamflow data from WRF-Hydro output files.
```{r}
refDF <- read.csv(referenceFile)

modelDF <- ReadChrtout(modelOutputPath, 
                       gageList=refDF$FID[refDF$SITE_NO==as.numeric(gageID)],
                       rtlinkFile=routeLinkFile)
```
Aggregate to daily streamflow and rename columns.
```{r}
modelDF$date <- as.Date(modelDF$POSIXct)
modelDailyDF <- aggregate(modelDF$q_cms, by=list(modelDF$date), FUN=mean)
colnames(modelDailyDF) <- c("date","q_cms")
modelDailyDF$POSIXct <- as.POSIXct(modelDailyDF$date)
```

# Download USGS streamflow observations
Download daily USGS streamflow observations using a function from the dataRetrieval package.
```{r}
obsDF <- readNWISdv(siteNumbers=gageID,
                    parameterCd="00060",
                    startDate=min(modelDF$date),
                    endDate=max(modelDF$date),
                    statCd="00003")
```
Rename columns and create a column for streamflow with units of cubic meters per second.
```{r}
colnames(obsDF) <- c("agency","site_no","date","q_cfs","qc")

obsDF$POSIXct <- as.POSIXct(obsDF$date)
obsDF$q_cms <- obsDF$q_cfs/35.31
```

# Plot hydrographs 
Plot observed and simulated hydrographs using ggplot2.
```{r, fig.width=7}
ggplot(data=obsDF,aes(x=date,y=q_cms,col="Observations")) + 
  geom_line() +
  geom_line(data=modelDailyDF,aes(x=date,y=q_cms,col="WRF-Hydro")) +
  scale_x_date(date_labels = "%b %y") +
  labs(x="Date",y=expression("Streamflow (m"^{3}*"/s)"),title=paste("Station: ",gageID)) +
  theme_bw()
```

# Calculate model performance statistics
Calculate model performance statistics using a function from rwrfhydro.  
```{r}
CalcModPerf(modelDailyDF,obsDF)
```